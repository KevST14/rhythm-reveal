{"version":3,"sources":["../../../src/server/request/search-params.browser.ts"],"sourcesContent":["import type { SearchParams } from './search-params'\n\nimport { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\nimport {\n  describeStringPropertyAccess,\n  describeHasCheckingStringProperty,\n  wellKnownProperties,\n} from './utils'\n\nexport function createRenderSearchParamsFromClient(\n  underlyingSearchParams: SearchParams\n): Promise<SearchParams> {\n  if (process.env.NODE_ENV === 'development') {\n    return makeUntrackedExoticSearchParamsWithDevWarnings(\n      underlyingSearchParams\n    )\n  } else {\n    return makeUntrackedExoticSearchParams(underlyingSearchParams)\n  }\n}\n\ninterface CacheLifetime {}\nconst CachedSearchParams = new WeakMap<CacheLifetime, Promise<SearchParams>>()\n\nfunction makeUntrackedExoticSearchParamsWithDevWarnings(\n  underlyingSearchParams: SearchParams\n): Promise<SearchParams> {\n  const cachedSearchParams = CachedSearchParams.get(underlyingSearchParams)\n  if (cachedSearchParams) {\n    return cachedSearchParams\n  }\n\n  const proxiedProperties = new Set<string>()\n  const unproxiedProperties: Array<string> = []\n\n  const promise = Promise.resolve(underlyingSearchParams)\n\n  Object.keys(underlyingSearchParams).forEach((prop) => {\n    if (wellKnownProperties.has(prop)) {\n      // These properties cannot be shadowed because they need to be the\n      // true underlying value for Promises to work correctly at runtime\n      unproxiedProperties.push(prop)\n    } else {\n      proxiedProperties.add(prop)\n      ;(promise as any)[prop] = underlyingSearchParams[prop]\n    }\n  })\n\n  const proxiedPromise = new Proxy(promise, {\n    get(target, prop, receiver) {\n      if (typeof prop === 'string') {\n        if (\n          !wellKnownProperties.has(prop) &&\n          (proxiedProperties.has(prop) ||\n            // We are accessing a property that doesn't exist on the promise nor\n            // the underlying searchParams.\n            Reflect.has(target, prop) === false)\n        ) {\n          const expression = describeStringPropertyAccess('searchParams', prop)\n          warnForSyncAccess(expression)\n        }\n      }\n      return ReflectAdapter.get(target, prop, receiver)\n    },\n    set(target, prop, value, receiver) {\n      if (typeof prop === 'string') {\n        proxiedProperties.delete(prop)\n      }\n      return Reflect.set(target, prop, value, receiver)\n    },\n    has(target, prop) {\n      if (typeof prop === 'string') {\n        if (\n          !wellKnownProperties.has(prop) &&\n          (proxiedProperties.has(prop) ||\n            // We are accessing a property that doesn't exist on the promise nor\n            // the underlying searchParams.\n            Reflect.has(target, prop) === false)\n        ) {\n          const expression = describeHasCheckingStringProperty(\n            'searchParams',\n            prop\n          )\n          warnForSyncAccess(expression)\n        }\n      }\n      return Reflect.has(target, prop)\n    },\n    ownKeys(target) {\n      warnForSyncSpread()\n      return Reflect.ownKeys(target)\n    },\n  })\n\n  CachedSearchParams.set(underlyingSearchParams, proxiedPromise)\n  return proxiedPromise\n}\n\nfunction makeUntrackedExoticSearchParams(\n  underlyingSearchParams: SearchParams\n): Promise<SearchParams> {\n  const cachedSearchParams = CachedSearchParams.get(underlyingSearchParams)\n  if (cachedSearchParams) {\n    return cachedSearchParams\n  }\n\n  // We don't use makeResolvedReactPromise here because searchParams\n  // supports copying with spread and we don't want to unnecessarily\n  // instrument the promise with spreadable properties of ReactPromise.\n  const promise = Promise.resolve(underlyingSearchParams)\n  CachedSearchParams.set(underlyingSearchParams, promise)\n\n  Object.keys(underlyingSearchParams).forEach((prop) => {\n    if (wellKnownProperties.has(prop)) {\n      // These properties cannot be shadowed because they need to be the\n      // true underlying value for Promises to work correctly at runtime\n    } else {\n      ;(promise as any)[prop] = underlyingSearchParams[prop]\n    }\n  })\n\n  return promise\n}\n\nconst noop = () => {}\n\nconst warnForSyncAccess = process.env.__NEXT_DISABLE_SYNC_DYNAMIC_API_WARNINGS\n  ? noop\n  : function warnForSyncAccess(expression: string) {\n      if (process.env.__NEXT_DISABLE_SYNC_DYNAMIC_API_WARNINGS) {\n        return\n      }\n\n      console.error(\n        `A searchParam property was accessed directly with ${expression}. ` +\n          `\\`searchParams\\` should be unwrapped with \\`React.use()\\` before accessing its properties. ` +\n          `Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis`\n      )\n    }\n\nconst warnForSyncSpread = process.env.__NEXT_DISABLE_SYNC_DYNAMIC_API_WARNINGS\n  ? noop\n  : function warnForSyncSpread() {\n      if (process.env.__NEXT_DISABLE_SYNC_DYNAMIC_API_WARNINGS) {\n        return\n      }\n\n      console.error(\n        `The keys of \\`searchParams\\` were accessed directly. ` +\n          `\\`searchParams\\` should be unwrapped with \\`React.use()\\` before accessing its properties. ` +\n          `Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis`\n      )\n    }\n"],"names":["ReflectAdapter","describeStringPropertyAccess","describeHasCheckingStringProperty","wellKnownProperties","createRenderSearchParamsFromClient","underlyingSearchParams","process","env","NODE_ENV","makeUntrackedExoticSearchParamsWithDevWarnings","makeUntrackedExoticSearchParams","CachedSearchParams","WeakMap","cachedSearchParams","get","proxiedProperties","Set","unproxiedProperties","promise","Promise","resolve","Object","keys","forEach","prop","has","push","add","proxiedPromise","Proxy","target","receiver","Reflect","expression","warnForSyncAccess","set","value","delete","ownKeys","warnForSyncSpread","noop","__NEXT_DISABLE_SYNC_DYNAMIC_API_WARNINGS","console","error"],"mappings":"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"}